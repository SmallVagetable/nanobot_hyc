# nanobot é¡¹ç›®æ·±åº¦ç†è§£æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

**nanobot** æ˜¯ä¸€ä¸ªè¶…è½»é‡çº§ä¸ªäºº AI åŠ©æ‰‹æ¡†æ¶ï¼Œæ ¸å¿ƒä»£ç ä»…çº¦ **3,510 è¡Œ**ï¼ˆç›¸æ¯” Clawdbot çš„ 430k+ è¡Œï¼Œå‡å°‘äº† 99%ï¼‰ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- ğŸª¶ **è¶…è½»é‡çº§**ï¼šæ ¸å¿ƒä»£ç çº¦ 4,000 è¡Œï¼Œ99% å°äº Clawdbot
- ğŸ”¬ **ç ”ç©¶å‹å¥½**ï¼šä»£ç æ¸…æ™°æ˜“è¯»ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
- âš¡ï¸ **å¿«é€Ÿå¯åŠ¨**ï¼šæœ€å°åŒ–ä¾èµ–ï¼Œå¿«é€Ÿå¯åŠ¨å’Œè¿­ä»£
- ğŸ’ **æ˜“äºä½¿ç”¨**ï¼šä¸€é”®éƒ¨ç½²å³å¯ä½¿ç”¨
- ğŸ”Œ **é«˜åº¦å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

### é¡¹ç›®å®šä½

nanobot æ—¨åœ¨æä¾›ä¸€ä¸ªè½»é‡ã€å¯æ‰©å±•çš„ AI åŠ©æ‰‹æ¡†æ¶ï¼Œé€‚åˆï¼š
- ä¸ªäºº AI åŠ©æ‰‹å¼€å‘
- å­¦æœ¯ç ”ç©¶å’Œå®éªŒ
- å¿«é€ŸåŸå‹å¼€å‘
- å¤šé€šé“èŠå¤©æœºå™¨äºº

---

## æ ¸å¿ƒæ¶æ„

### 1. æ¶ˆæ¯æ€»çº¿æ¶æ„ (Message Bus)

**ä½ç½®**: `nanobot/bus/queue.py`

æ¶ˆæ¯æ€»çº¿æ˜¯ nanobot çš„æ ¸å¿ƒé€šä¿¡æœºåˆ¶ï¼Œå®ç°äº†é€šé“ä¸ Agent çš„å®Œå…¨è§£è€¦ã€‚

#### è®¾è®¡åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Channels  â”‚ â”€â”€â”€â”€â”€â”€> â”‚ Message Bus  â”‚ <â”€â”€â”€â”€â”€â”€ â”‚ Agent Loop  â”‚
â”‚ (Telegram,  â”‚ inbound â”‚              â”‚outbound â”‚             â”‚
â”‚  Discord...)â”‚         â”‚              â”‚         â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **inbound é˜Ÿåˆ—**: æ¥æ”¶æ¥è‡ªæ‰€æœ‰é€šé“çš„ç”¨æˆ·æ¶ˆæ¯
- **outbound é˜Ÿåˆ—**: å‘é€ Agent çš„å“åº”åˆ°å¯¹åº”é€šé“
- **å¼‚æ­¥å¤„ç†**: åŸºäº `asyncio.Queue` å®ç°éé˜»å¡æ¶ˆæ¯ä¼ é€’

#### å…³é”®ç‰¹æ€§

- å®Œå…¨è§£è€¦ï¼šé€šé“å’Œ Agent äº’ä¸ä¾èµ–
- ç»Ÿä¸€æ¥å£ï¼šæ‰€æœ‰é€šé“é€šè¿‡ç›¸åŒçš„æ¶ˆæ¯æ ¼å¼é€šä¿¡
- å¼‚æ­¥é«˜æ•ˆï¼šæ”¯æŒé«˜å¹¶å‘æ¶ˆæ¯å¤„ç†

---

### 2. Agent æ ¸å¿ƒå¾ªç¯ (Agent Loop)

**ä½ç½®**: `nanobot/agent/loop.py`

Agent Loop æ˜¯ nanobot çš„æ ¸å¿ƒå¤„ç†å¼•æ“ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯ã€‚

#### å·¥ä½œæµç¨‹

```
1. æ¥æ”¶æ¶ˆæ¯ (ä» MessageBus.inbound)
   â†“
2. æ„å»ºä¸Šä¸‹æ–‡ (å†å² + è®°å¿† + æŠ€èƒ½)
   â†“
3. è°ƒç”¨ LLM (é€šè¿‡ Provider)
   â†“
4. æ£€æŸ¥å·¥å…·è°ƒç”¨
   â”œâ”€ æœ‰å·¥å…·è°ƒç”¨ â†’ æ‰§è¡Œå·¥å…· â†’ ç»§ç»­è¿­ä»£ (æœ€å¤š20æ¬¡)
   â””â”€ æ— å·¥å…·è°ƒç”¨ â†’ ç”Ÿæˆæœ€ç»ˆå“åº”
   â†“
5. å‘é€å“åº” (åˆ° MessageBus.outbound)
```

#### æ ¸å¿ƒç»„ä»¶

- **ContextBuilder**: æ„å»ºç³»ç»Ÿæç¤ºå’Œæ¶ˆæ¯åˆ—è¡¨
- **SessionManager**: ç®¡ç†ä¼šè¯å†å²
- **ToolRegistry**: æ³¨å†Œå’Œæ‰§è¡Œå·¥å…·
- **SubagentManager**: ç®¡ç†åå°å­ä»£ç†

#### è¿­ä»£æœºåˆ¶

- æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼š20 æ¬¡
- æ¯æ¬¡è¿­ä»£å¯ä»¥è°ƒç”¨å¤šä¸ªå·¥å…·
- å·¥å…·æ‰§è¡Œç»“æœä¼šæ·»åŠ åˆ°æ¶ˆæ¯å†å²ä¸­
- å½“ LLM è¿”å›çº¯æ–‡æœ¬å“åº”æ—¶ï¼Œå¾ªç¯ç»“æŸ

---

### 3. ä¸Šä¸‹æ–‡æ„å»ºç³»ç»Ÿ (Context Builder)

**ä½ç½®**: `nanobot/agent/context.py`

ContextBuilder è´Ÿè´£å°†å„ç§ä¿¡æ¯æºæ•´åˆæˆå®Œæ•´çš„ç³»ç»Ÿæç¤ºã€‚

#### ä¸Šä¸‹æ–‡ç»„æˆ

1. **æ ¸å¿ƒèº«ä»½** (`_get_identity`)
   - nanobot çš„åŸºç¡€èº«ä»½è¯´æ˜
   - å¯ç”¨å·¥å…·åˆ—è¡¨
   - å½“å‰æ—¶é—´å’Œè¿è¡Œæ—¶ä¿¡æ¯
   - å·¥ä½œåŒºè·¯å¾„

2. **Bootstrap æ–‡ä»¶**
   - `AGENTS.md`: Agent æŒ‡ä»¤å’Œè¡Œä¸ºè§„èŒƒ
   - `SOUL.md`: ä¸ªæ€§ç‰¹å¾
   - `USER.md`: ç”¨æˆ·ä¿¡æ¯
   - `TOOLS.md`: å·¥å…·ä½¿ç”¨è¯´æ˜
   - `IDENTITY.md`: èº«ä»½å®šä¹‰

3. **è®°å¿†ç³»ç»Ÿ**
   - é•¿æœŸè®°å¿†ï¼š`memory/MEMORY.md`
   - æ¯æ—¥ç¬”è®°ï¼š`memory/YYYY-MM-DD.md`
   - æœ€è¿‘ 7 å¤©çš„è®°å¿†æ‘˜è¦

4. **æŠ€èƒ½ç³»ç»Ÿ**ï¼ˆæ¸è¿›å¼åŠ è½½ï¼‰
   - **Always æŠ€èƒ½**: è‡ªåŠ¨åŠ è½½å®Œæ•´å†…å®¹
   - **å…¶ä»–æŠ€èƒ½**: ä»…æ˜¾ç¤ºæ‘˜è¦ï¼ŒAgent æŒ‰éœ€è¯»å–

#### æ¶ˆæ¯æ„å»º

- ç³»ç»Ÿæç¤ºï¼šåŒ…å«ä¸Šè¿°æ‰€æœ‰ä¸Šä¸‹æ–‡
- å†å²æ¶ˆæ¯ï¼šä» Session è·å–æœ€è¿‘ 50 æ¡
- å½“å‰æ¶ˆæ¯ï¼šç”¨æˆ·è¾“å…¥ï¼ˆæ”¯æŒå›¾ç‰‡é™„ä»¶ï¼‰
- å·¥å…·ç»“æœï¼šæ¯æ¬¡å·¥å…·è°ƒç”¨åæ·»åŠ ç»“æœ

---

### 4. æŠ€èƒ½ç³»ç»Ÿ (Skills System)

**ä½ç½®**: `nanobot/agent/skills.py`

æŠ€èƒ½ç³»ç»Ÿå…è®¸ Agent é€šè¿‡ Markdown æ–‡æ¡£å­¦ä¹ æ–°èƒ½åŠ›ã€‚

#### æŠ€èƒ½æ ¼å¼

æ¯ä¸ªæŠ€èƒ½æ˜¯ä¸€ä¸ªç›®å½•ï¼ŒåŒ…å« `SKILL.md` æ–‡ä»¶ï¼š

```
skills/
â”œâ”€â”€ github/
â”‚   â””â”€â”€ SKILL.md
â”œâ”€â”€ weather/
â”‚   â””â”€â”€ SKILL.md
â””â”€â”€ ...
```

#### æŠ€èƒ½å…ƒæ•°æ®

æŠ€èƒ½å¯ä»¥é€šè¿‡ YAML frontmatter å®šä¹‰å…ƒæ•°æ®ï¼š

```yaml
---
name: "skill-name"
description: "æŠ€èƒ½æè¿°"
always: true  # æ˜¯å¦è‡ªåŠ¨åŠ è½½
requires:
  bins: ["command1", "command2"]  # éœ€è¦çš„ CLI å·¥å…·
  env: ["ENV_VAR"]  # éœ€è¦çš„ç¯å¢ƒå˜é‡
---
```

#### æ¸è¿›å¼åŠ è½½ç­–ç•¥

1. **Always æŠ€èƒ½**: æ ‡è®°ä¸º `always: true` çš„æŠ€èƒ½ä¼šè‡ªåŠ¨åŠ è½½åˆ°ç³»ç»Ÿæç¤ºä¸­
2. **æŒ‰éœ€æŠ€èƒ½**: å…¶ä»–æŠ€èƒ½åªæ˜¾ç¤ºæ‘˜è¦ï¼ŒAgent ä½¿ç”¨ `read_file` å·¥å…·æŒ‰éœ€è¯»å–
3. **ä¾èµ–æ£€æŸ¥**: è‡ªåŠ¨æ£€æŸ¥æŠ€èƒ½æ‰€éœ€çš„ç¯å¢ƒå˜é‡å’Œ CLI å·¥å…·

#### å†…ç½®æŠ€èƒ½

- `github`: ä½¿ç”¨ `gh` CLI ä¸ GitHub äº¤äº’
- `weather`: ä½¿ç”¨ wttr.in å’Œ Open-Meteo è·å–å¤©æ°”
- `summarize`: æ‘˜è¦ URLã€æ–‡ä»¶å’Œ YouTube è§†é¢‘
- `tmux`: è¿œç¨‹æ§åˆ¶ tmux ä¼šè¯
- `skill-creator`: åˆ›å»ºæ–°æŠ€èƒ½

#### æŠ€èƒ½ä¼˜å…ˆçº§

1. **Workspace æŠ€èƒ½** (æœ€é«˜ä¼˜å…ˆçº§)
2. **å†…ç½®æŠ€èƒ½** (fallback)

---

### 5. å·¥å…·ç³»ç»Ÿ (Tools System)

**ä½ç½®**: `nanobot/agent/tools/`

å·¥å…·ç³»ç»Ÿæä¾›äº† Agent ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’çš„èƒ½åŠ›ã€‚

#### å·¥å…·æ³¨å†Œè¡¨

**ä½ç½®**: `nanobot/agent/tools/registry.py`

- åŠ¨æ€æ³¨å†Œï¼šè¿è¡Œæ—¶æ³¨å†Œå’Œæ³¨é”€å·¥å…·
- å‚æ•°éªŒè¯ï¼šæ‰§è¡Œå‰éªŒè¯å‚æ•°
- é”™è¯¯å¤„ç†ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

#### å†…ç½®å·¥å…·

##### æ–‡ä»¶æ“ä½œå·¥å…·

- `read_file`: è¯»å–æ–‡ä»¶å†…å®¹
- `write_file`: å†™å…¥æ–‡ä»¶
- `edit_file`: ç¼–è¾‘æ–‡ä»¶ï¼ˆæ”¯æŒè¡Œå·å®šä½ï¼‰
- `list_dir`: åˆ—å‡ºç›®å½•å†…å®¹

**å®‰å…¨ç‰¹æ€§**: å¯é…ç½®ä¸ºé™åˆ¶åœ¨å·¥ä½œåŒºç›®å½•å†…

##### Shell æ‰§è¡Œå·¥å…·

- `exec`: æ‰§è¡Œ shell å‘½ä»¤
  - æ”¯æŒè¶…æ—¶è®¾ç½®ï¼ˆé»˜è®¤ 60 ç§’ï¼‰
  - æ”¯æŒå·¥ä½œç›®å½•é™åˆ¶
  - å¯é…ç½®ä¸ºé™åˆ¶åœ¨å·¥ä½œåŒº

##### Web å·¥å…·

- `web_search`: ä½¿ç”¨ Brave Search API æœç´¢ç½‘ç»œ
- `web_fetch`: è·å–ç½‘é¡µå†…å®¹ï¼ˆæ”¯æŒå†…å®¹æå–ï¼‰

##### æ¶ˆæ¯å·¥å…·

- `message`: å‘é€æ¶ˆæ¯åˆ°èŠå¤©é€šé“
  - æ”¯æŒæŒ‡å®šé€šé“å’ŒèŠå¤© ID
  - ç”¨äºè·¨é€šé“é€šä¿¡

##### å­ä»£ç†å·¥å…·

- `spawn`: åˆ›å»ºåå°å­ä»£ç†æ‰§è¡Œä»»åŠ¡
  - å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸» Agent
  - å®Œæˆåè‡ªåŠ¨é€šçŸ¥

##### å®šæ—¶ä»»åŠ¡å·¥å…·

- `cron`: ç®¡ç†å®šæ—¶ä»»åŠ¡
  - æ·»åŠ ã€åˆ é™¤ã€åˆ—å‡ºä»»åŠ¡
  - æ”¯æŒ cron è¡¨è¾¾å¼å’Œé—´éš”æ—¶é—´

#### å·¥å…·æ¥å£

æ‰€æœ‰å·¥å…·å®ç° `Tool` åŸºç±»ï¼š

```python
class Tool(ABC):
    @property
    @abstractmethod
    def name(self) -> str: ...
    
    @property
    @abstractmethod
    def description(self) -> str: ...
    
    @property
    @abstractmethod
    def parameters(self) -> dict[str, Any]: ...
    
    @abstractmethod
    async def execute(self, **kwargs: Any) -> str: ...
```

---

### 6. å¤šé€šé“æ”¯æŒ (Multi-Channel Support)

**ä½ç½®**: `nanobot/channels/`

nanobot æ”¯æŒå¤šç§èŠå¤©å¹³å°ï¼Œæ‰€æœ‰é€šé“é€šè¿‡ç»Ÿä¸€æ¥å£æ¥å…¥ã€‚

#### é€šé“æ¶æ„

```
BaseChannel (æŠ½è±¡åŸºç±»)
â”œâ”€â”€ TelegramChannel
â”œâ”€â”€ DiscordChannel
â”œâ”€â”€ WhatsAppChannel
â”œâ”€â”€ FeishuChannel
â”œâ”€â”€ MochatChannel
â”œâ”€â”€ DingTalkChannel
â”œâ”€â”€ SlackChannel
â”œâ”€â”€ EmailChannel
â””â”€â”€ QQChannel
```

#### é€šé“ç®¡ç†å™¨

**ä½ç½®**: `nanobot/channels/manager.py`

- åˆå§‹åŒ–ï¼šæ ¹æ®é…ç½®åˆå§‹åŒ–å¯ç”¨çš„é€šé“
- å¯åŠ¨/åœæ­¢ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰é€šé“çš„ç”Ÿå‘½å‘¨æœŸ
- æ¶ˆæ¯åˆ†å‘ï¼šå°† outbound æ¶ˆæ¯è·¯ç”±åˆ°å¯¹åº”é€šé“

#### æ”¯æŒçš„é€šé“

| é€šé“ | è¿æ¥æ–¹å¼ | ç‰¹ç‚¹ |
|------|---------|------|
| **Telegram** | Bot API | æ¨èï¼Œé…ç½®ç®€å• |
| **Discord** | Gateway WebSocket | æ”¯æŒæœåŠ¡å™¨å’Œç§èŠ |
| **WhatsApp** | Node.js Bridge | éœ€è¦æ‰«æäºŒç»´ç  |
| **Feishu** | WebSocket é•¿è¿æ¥ | æ— éœ€å…¬ç½‘ IP |
| **Mochat** | Socket.IO | Claw IM é›†æˆ |
| **DingTalk** | Stream æ¨¡å¼ | æ— éœ€å…¬ç½‘ IP |
| **Slack** | Socket Mode | æ— éœ€å…¬ç½‘ URL |
| **Email** | IMAP/SMTP | é‚®ä»¶åŠ©æ‰‹ |
| **QQ** | botpy SDK | ä»…æ”¯æŒç§èŠ |

#### ç»Ÿä¸€æ¥å£

æ‰€æœ‰é€šé“å®ç° `BaseChannel` æ¥å£ï¼š

```python
class BaseChannel(ABC):
    @abstractmethod
    async def start(self) -> None: ...
    
    @abstractmethod
    async def stop(self) -> None: ...
    
    @abstractmethod
    async def send(self, msg: OutboundMessage) -> None: ...
    
    def is_allowed(self, sender_id: str) -> bool: ...
```

#### è®¿é—®æ§åˆ¶

- `allowFrom`: ç™½åå•æœºåˆ¶
- ç©ºåˆ—è¡¨ = å…è®¸æ‰€æœ‰äºº
- éç©ºåˆ—è¡¨ = ä»…å…è®¸åˆ—è¡¨ä¸­çš„ç”¨æˆ·

---

### 7. å¤š LLM æä¾›å•†æ”¯æŒ (Multi-Provider Support)

**ä½ç½®**: `nanobot/providers/`

nanobot é€šè¿‡ LiteLLM ç»Ÿä¸€æ¥å£æ”¯æŒå¤šç§ LLM æä¾›å•†ã€‚

#### æä¾›å•†æ¶æ„

```
LLMProvider (æŠ½è±¡åŸºç±»)
â””â”€â”€ LiteLLMProvider (å®ç°)
    â””â”€â”€ ProviderRegistry (æ³¨å†Œè¡¨)
```

#### æä¾›å•†æ³¨å†Œè¡¨

**ä½ç½®**: `nanobot/providers/registry.py`

é€šè¿‡ `ProviderSpec` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æä¾›å•†ï¼š

```python
@dataclass(frozen=True)
class ProviderSpec:
    name: str                    # é…ç½®å­—æ®µå
    keywords: tuple[str, ...]    # æ¨¡å‹åå…³é”®è¯
    env_key: str                 # LiteLLM ç¯å¢ƒå˜é‡
    litellm_prefix: str          # æ¨¡å‹å‰ç¼€
    is_gateway: bool             # æ˜¯å¦ä¸ºç½‘å…³
    is_local: bool               # æ˜¯å¦ä¸ºæœ¬åœ°éƒ¨ç½²
    # ... æ›´å¤šé…ç½®
```

#### æ·»åŠ æ–°æä¾›å•†ï¼ˆä»…éœ€ 2 æ­¥ï¼‰

1. **åœ¨ `registry.py` æ·»åŠ  ProviderSpec**:
```python
ProviderSpec(
    name="myprovider",
    keywords=("myprovider", "mymodel"),
    env_key="MYPROVIDER_API_KEY",
    display_name="My Provider",
    litellm_prefix="myprovider",
    # ...
)
```

2. **åœ¨ `schema.py` æ·»åŠ é…ç½®å­—æ®µ**:
```python
class ProvidersConfig(BaseModel):
    myprovider: ProviderConfig = Field(default_factory=ProviderConfig)
```

#### æ”¯æŒçš„æä¾›å•†

##### ç½‘å…³ç±»ï¼ˆå¯è·¯ç”±ä»»ä½•æ¨¡å‹ï¼‰

- **OpenRouter**: å…¨çƒç½‘å…³ï¼Œæ”¯æŒæ‰€æœ‰æ¨¡å‹
- **AiHubMix**: API ç½‘å…³ï¼ŒOpenAI å…¼å®¹æ¥å£

##### æ ‡å‡†æä¾›å•†

- **Anthropic**: Claude ç³»åˆ—
- **OpenAI**: GPT ç³»åˆ—
- **DeepSeek**: DeepSeek æ¨¡å‹
- **Gemini**: Google Gemini
- **Zhipu**: GLM ç³»åˆ—
- **DashScope**: é˜¿é‡Œäº‘é€šä¹‰åƒé—®
- **Moonshot**: Kimi ç³»åˆ—
- **MiniMax**: MiniMax æ¨¡å‹

##### æœ¬åœ°éƒ¨ç½²

- **vLLM**: ä»»ä½• OpenAI å…¼å®¹çš„æœ¬åœ°æœåŠ¡å™¨

##### è¾…åŠ©åŠŸèƒ½

- **Groq**: ä¸»è¦ç”¨äº Whisper è¯­éŸ³è½¬å½•

#### æ¨¡å‹è·¯ç”±æœºåˆ¶

1. **å…³é”®è¯åŒ¹é…**: æ ¹æ®æ¨¡å‹åä¸­çš„å…³é”®è¯åŒ¹é…æä¾›å•†
2. **ç½‘å…³æ£€æµ‹**: é€šè¿‡ API key å‰ç¼€æˆ– API base URL æ£€æµ‹ç½‘å…³
3. **å‰ç¼€å¤„ç†**: è‡ªåŠ¨æ·»åŠ  LiteLLM æ‰€éœ€çš„å‰ç¼€
4. **å‚æ•°è¦†ç›–**: æ”¯æŒæ¨¡å‹ç‰¹å®šçš„å‚æ•°è¦†ç›–ï¼ˆå¦‚æ¸©åº¦ï¼‰

---

### 8. å­ä»£ç†ç³»ç»Ÿ (Subagent System)

**ä½ç½®**: `nanobot/agent/subagent.py`

å­ä»£ç†ç³»ç»Ÿå…è®¸ Agent åˆ›å»ºåå°ä»»åŠ¡ï¼Œæ‰§è¡Œå¤æ‚æˆ–è€—æ—¶çš„æ“ä½œã€‚

#### è®¾è®¡åŸç†

- **è½»é‡çº§**: å…±äº«ç›¸åŒçš„ LLM Providerï¼Œä½†ä½¿ç”¨ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡
- **å¼‚æ­¥æ‰§è¡Œ**: ä¸é˜»å¡ä¸» Agent çš„æ¶ˆæ¯å¤„ç†
- **ç»“æœé€šçŸ¥**: å®Œæˆåé€šè¿‡ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥ä¸» Agent

#### å·¥ä½œæµç¨‹

```
1. ä¸» Agent è°ƒç”¨ spawn å·¥å…·
   â†“
2. SubagentManager åˆ›å»ºåå°ä»»åŠ¡
   â†“
3. å­ä»£ç†æ‰§è¡Œä»»åŠ¡ï¼ˆç‹¬ç«‹å¾ªç¯ï¼‰
   â†“
4. å®Œæˆåå‘å¸ƒç³»ç»Ÿæ¶ˆæ¯åˆ° MessageBus
   â†“
5. ä¸» Agent å¤„ç†ç³»ç»Ÿæ¶ˆæ¯å¹¶é€šçŸ¥ç”¨æˆ·
```

#### ä½¿ç”¨åœºæ™¯

- é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
- éœ€è¦å¤šæ­¥éª¤å¤„ç†çš„ä»»åŠ¡
- ä¸é˜»å¡ç”¨æˆ·äº¤äº’çš„åå°ä»»åŠ¡

---

### 9. ä¼šè¯ç®¡ç† (Session Management)

**ä½ç½®**: `nanobot/session/manager.py`

ä¼šè¯ç®¡ç†ç³»ç»Ÿç»´æŠ¤æ¯ä¸ªå¯¹è¯çš„å†å²è®°å½•ã€‚

#### ä¼šè¯æ ‡è¯†

- æ ¼å¼: `{channel}:{chat_id}`
- ç¤ºä¾‹: `telegram:123456789`, `cli:default`

#### å­˜å‚¨æ ¼å¼

- **æ ¼å¼**: JSONL (æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡)
- **ä½ç½®**: `~/.nanobot/sessions/{safe_key}.jsonl`
- **ç»“æ„**:
  ```jsonl
  {"_type": "metadata", "created_at": "...", "updated_at": "...", "metadata": {}}
  {"role": "user", "content": "...", "timestamp": "..."}
  {"role": "assistant", "content": "...", "timestamp": "..."}
  ```

#### ç‰¹æ€§

- **å†å²é™åˆ¶**: é»˜è®¤è¿”å›æœ€è¿‘ 50 æ¡æ¶ˆæ¯ï¼ˆå¯é…ç½®ï¼‰
- **è‡ªåŠ¨æŒä¹…åŒ–**: æ¯æ¬¡å¯¹è¯åè‡ªåŠ¨ä¿å­˜
- **å†…å­˜ç¼“å­˜**: æ´»è·ƒä¼šè¯ç¼“å­˜åœ¨å†…å­˜ä¸­

---

### 10. è®°å¿†ç³»ç»Ÿ (Memory System)

**ä½ç½®**: `nanobot/agent/memory.py`

è®°å¿†ç³»ç»Ÿæä¾›ä¸¤å±‚è®°å¿†æœºåˆ¶ï¼Œå¸®åŠ© Agent è®°ä½é‡è¦ä¿¡æ¯ã€‚

#### è®°å¿†å±‚æ¬¡

1. **æ¯æ—¥ç¬”è®°** (`memory/YYYY-MM-DD.md`)
   - æŒ‰æ—¥æœŸç»„ç»‡çš„ä¸´æ—¶è®°å¿†
   - è‡ªåŠ¨åˆ›å»ºå’Œè¿½åŠ 
   - ç”¨äºè®°å½•å½“å¤©çš„æ´»åŠ¨å’Œæƒ³æ³•

2. **é•¿æœŸè®°å¿†** (`memory/MEMORY.md`)
   - æŒä¹…åŒ–çš„é‡è¦ä¿¡æ¯
   - ç”¨æˆ·ä¿¡æ¯ã€åå¥½ã€é¡¹ç›®ä¸Šä¸‹æ–‡
   - éœ€è¦é•¿æœŸè®°ä½çš„å†…å®¹

#### è®°å¿†ä¸Šä¸‹æ–‡

- è‡ªåŠ¨åŠ è½½åˆ°ç³»ç»Ÿæç¤ºä¸­
- åŒ…å«æœ€è¿‘ 7 å¤©çš„æ¯æ—¥ç¬”è®°æ‘˜è¦
- åŒ…å«å®Œæ•´çš„é•¿æœŸè®°å¿†

#### ä½¿ç”¨æ–¹å¼

Agent å¯ä»¥é€šè¿‡æ–‡ä»¶å·¥å…·ç›´æ¥è¯»å†™è®°å¿†æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†è®°å¿†å†…å®¹åŠ è½½åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚

---

## é…ç½®ç³»ç»Ÿ

### é…ç½®æ–‡ä»¶ä½ç½®

`~/.nanobot/config.json`

### é…ç½®ç»“æ„

```json
{
  "agents": {
    "defaults": {
      "workspace": "~/.nanobot/workspace",
      "model": "anthropic/claude-opus-4-5",
      "max_tokens": 8192,
      "temperature": 0.7,
      "max_tool_iterations": 20
    }
  },
  "channels": {
    "telegram": {
      "enabled": true,
      "token": "YOUR_BOT_TOKEN",
      "allowFrom": []
    }
  },
  "providers": {
    "openrouter": {
      "apiKey": "sk-or-v1-xxx"
    }
  },
  "tools": {
    "restrictToWorkspace": false,
    "exec": {
      "timeout": 60
    }
  }
}
```

### ä¸»è¦é…ç½®é¡¹

- **agents**: Agent é»˜è®¤é…ç½®
- **channels**: å„é€šé“é…ç½®
- **providers**: LLM æä¾›å•†é…ç½®
- **tools**: å·¥å…·é…ç½®ï¼ˆè¶…æ—¶ã€å·¥ä½œåŒºé™åˆ¶ç­‰ï¼‰

---

## å®Œæ•´å·¥ä½œæµç¨‹

### æ¶ˆæ¯å¤„ç†æµç¨‹

```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
   â†“
2. é€šé“æ¥æ”¶æ¶ˆæ¯
   â”œâ”€ Telegram â†’ TelegramChannel
   â”œâ”€ Discord â†’ DiscordChannel
   â””â”€ ...
   â†“
3. é€šé“å‘å¸ƒåˆ° MessageBus.inbound
   â†“
4. Agent Loop æ¶ˆè´¹æ¶ˆæ¯
   â†“
5. Context Builder æ„å»ºä¸Šä¸‹æ–‡
   â”œâ”€ åŠ è½½ç³»ç»Ÿæç¤ºï¼ˆèº«ä»½ + Bootstrap + è®°å¿† + æŠ€èƒ½ï¼‰
   â”œâ”€ åŠ è½½ä¼šè¯å†å²ï¼ˆæœ€è¿‘ 50 æ¡ï¼‰
   â””â”€ æ·»åŠ å½“å‰æ¶ˆæ¯
   â†“
6. è°ƒç”¨ LLM (é€šè¿‡ LiteLLM Provider)
   â†“
7. LLM è¿”å›å“åº”
   â”œâ”€ æœ‰å·¥å…·è°ƒç”¨
   â”‚  â”œâ”€ æ‰§è¡Œå·¥å…·
   â”‚  â”œâ”€ æ·»åŠ å·¥å…·ç»“æœåˆ°æ¶ˆæ¯å†å²
   â”‚  â””â”€ ç»§ç»­è¿­ä»£ï¼ˆæœ€å¤š 20 æ¬¡ï¼‰
   â””â”€ æ— å·¥å…·è°ƒç”¨
      â””â”€ ç”Ÿæˆæœ€ç»ˆå“åº”
   â†“
8. ä¿å­˜åˆ°ä¼šè¯å†å²
   â†“
9. å‘å¸ƒå“åº”åˆ° MessageBus.outbound
   â†“
10. Channel Manager åˆ†å‘åˆ°å¯¹åº”é€šé“
   â†“
11. é€šé“å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·
   â†“
12. ç”¨æˆ·æ”¶åˆ°å›å¤
```

### å·¥å…·è°ƒç”¨æµç¨‹

```
1. LLM å†³å®šè°ƒç”¨å·¥å…·
   â†“
2. ç”Ÿæˆå·¥å…·è°ƒç”¨è¯·æ±‚
   {
     "name": "read_file",
     "arguments": {"path": "file.txt"}
   }
   â†“
3. ToolRegistry æŸ¥æ‰¾å·¥å…·
   â†“
4. éªŒè¯å‚æ•°
   â†“
5. æ‰§è¡Œå·¥å…·
   â†“
6. è¿”å›ç»“æœå­—ç¬¦ä¸²
   â†“
7. æ·»åŠ åˆ°æ¶ˆæ¯å†å²
   {
     "role": "tool",
     "tool_call_id": "...",
     "name": "read_file",
     "content": "æ–‡ä»¶å†…å®¹..."
   }
   â†“
8. ç»§ç»­ Agent Loop è¿­ä»£
```

---

## è®¾è®¡äº®ç‚¹

### 1. è¶…è½»é‡çº§è®¾è®¡

- æ ¸å¿ƒä»£ç ä»… 3,510 è¡Œ
- æœ€å°åŒ–ä¾èµ–
- å¿«é€Ÿå¯åŠ¨å’Œè¿è¡Œ

### 2. æ¨¡å—åŒ–æ¶æ„

- å„ç»„ä»¶å®Œå…¨è§£è€¦
- é€šè¿‡æ¥å£å’Œæ¶ˆæ¯æ€»çº¿é€šä¿¡
- æ˜“äºæ‰©å±•å’Œç»´æŠ¤

### 3. æ¸è¿›å¼æŠ€èƒ½åŠ è½½

- Always æŠ€èƒ½è‡ªåŠ¨åŠ è½½
- å…¶ä»–æŠ€èƒ½æŒ‰éœ€è¯»å–
- å‡å°‘ token æ¶ˆè€—

### 4. ç»Ÿä¸€æ¥å£è®¾è®¡

- æ‰€æœ‰é€šé“å®ç°ç›¸åŒæ¥å£
- æ‰€æœ‰å·¥å…·å®ç°ç›¸åŒåŸºç±»
- æ‰€æœ‰æä¾›å•†é€šè¿‡ç»Ÿä¸€æ¥å£æ¥å…¥

### 5. å®‰å…¨å¯æ§

- å·¥ä½œåŒºé™åˆ¶
- å‚æ•°éªŒè¯
- è®¿é—®æ§åˆ¶ï¼ˆallowFromï¼‰
- è¶…æ—¶ä¿æŠ¤

### 6. ç ”ç©¶å‹å¥½

- ä»£ç æ¸…æ™°æ˜“è¯»
- æ³¨é‡Šè¯¦ç»†
- æ˜“äºç†è§£å’Œä¿®æ”¹

---

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°é€šé“

1. åœ¨ `nanobot/channels/` åˆ›å»ºæ–°æ–‡ä»¶
2. å®ç° `BaseChannel` æ¥å£
3. åœ¨ `ChannelManager._init_channels()` ä¸­æ³¨å†Œ

### æ·»åŠ æ–°å·¥å…·

1. åœ¨ `nanobot/agent/tools/` åˆ›å»ºæ–°æ–‡ä»¶
2. ç»§æ‰¿ `Tool` åŸºç±»
3. å®ç° `name`, `description`, `parameters`, `execute`
4. åœ¨ `AgentLoop._register_default_tools()` ä¸­æ³¨å†Œ

### æ·»åŠ æ–°æŠ€èƒ½

1. åœ¨ `workspace/skills/` æˆ– `nanobot/skills/` åˆ›å»ºç›®å½•
2. åˆ›å»º `SKILL.md` æ–‡ä»¶
3. å¯é€‰ï¼šæ·»åŠ  YAML frontmatter å®šä¹‰å…ƒæ•°æ®

### æ·»åŠ æ–° LLM æä¾›å•†

1. åœ¨ `nanobot/providers/registry.py` æ·»åŠ  `ProviderSpec`
2. åœ¨ `nanobot/config/schema.py` æ·»åŠ é…ç½®å­—æ®µ

---

## å…³é”®æ–‡ä»¶ç´¢å¼•

### æ ¸å¿ƒæ–‡ä»¶

- `nanobot/agent/loop.py`: Agent æ ¸å¿ƒå¾ªç¯
- `nanobot/agent/context.py`: ä¸Šä¸‹æ–‡æ„å»º
- `nanobot/agent/skills.py`: æŠ€èƒ½åŠ è½½
- `nanobot/bus/queue.py`: æ¶ˆæ¯æ€»çº¿
- `nanobot/channels/manager.py`: é€šé“ç®¡ç†

### å·¥å…·æ–‡ä»¶

- `nanobot/agent/tools/registry.py`: å·¥å…·æ³¨å†Œè¡¨
- `nanobot/agent/tools/base.py`: å·¥å…·åŸºç±»
- `nanobot/agent/tools/*.py`: å„ç§å·¥å…·å®ç°

### æä¾›å•†æ–‡ä»¶

- `nanobot/providers/base.py`: Provider åŸºç±»
- `nanobot/providers/litellm_provider.py`: LiteLLM å®ç°
- `nanobot/providers/registry.py`: æä¾›å•†æ³¨å†Œè¡¨

### é…ç½®æ–‡ä»¶

- `nanobot/config/schema.py`: é…ç½®æ¨¡å¼å®šä¹‰
- `nanobot/config/loader.py`: é…ç½®åŠ è½½å™¨

### CLI æ–‡ä»¶

- `nanobot/cli/commands.py`: CLI å‘½ä»¤å®ç°

---

## æ€»ç»“

nanobot æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯çš„è¶…è½»é‡çº§ AI åŠ©æ‰‹æ¡†æ¶ï¼Œé€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç°äº†è½»é‡ã€å¯æ‰©å±•ã€æ˜“ç”¨çš„ç›®æ ‡ï¼š

1. **æ¶ˆæ¯æ€»çº¿æ¶æ„**: å®Œå…¨è§£è€¦é€šé“å’Œ Agent
2. **æ¨¡å—åŒ–è®¾è®¡**: å„ç»„ä»¶ç‹¬ç«‹ï¼Œæ˜“äºæ‰©å±•
3. **æ¸è¿›å¼åŠ è½½**: æŒ‰éœ€åŠ è½½æŠ€èƒ½ï¼Œå‡å°‘ token æ¶ˆè€—
4. **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰æ‰©å±•ç‚¹éƒ½æœ‰ç»Ÿä¸€æ¥å£
5. **å®‰å…¨å¯æ§**: å¤šå±‚å®‰å…¨æœºåˆ¶ä¿æŠ¤ç³»ç»Ÿ
6. **ç ”ç©¶å‹å¥½**: ä»£ç æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹

è¿™ä½¿å¾— nanobot æ—¢é€‚åˆä¸ªäººä½¿ç”¨ï¼Œä¹Ÿé€‚åˆå­¦æœ¯ç ”ç©¶å’ŒäºŒæ¬¡å¼€å‘ã€‚

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-02-11*
*åŸºäº nanobot v0.1.3.post6*
